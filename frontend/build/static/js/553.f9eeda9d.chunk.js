"use strict";(self.webpackChunkadmin_dashboard_template_OptiStock=self.webpackChunkadmin_dashboard_template_OptiStock||[]).push([[553],{5176:(e,a,t)=>{t.d(a,{Z:()=>l});var r=t(184);const s=function(e){let{styleClass:a,children:t}=e;return(0,r.jsx)("div",{className:"text-xl font-semibold ".concat(a),children:t})};const l=function(e){let{title:a,children:t,topMargin:l,TopSideButtons:n}=e;return(0,r.jsxs)("div",{className:"card w-full p-6 bg-base-100 shadow-xl "+(l||"mt-6"),children:[(0,r.jsxs)(s,{styleClass:n?"inline-block":"",children:[a,n&&(0,r.jsx)("div",{className:"inline-block float-right",children:n})]}),(0,r.jsx)("div",{className:"divider mt-2"}),(0,r.jsx)("div",{className:"h-full w-full pb-6 bg-base-100",children:t})]})}},7553:(e,a,t)=>{t.r(a),t.d(a,{default:()=>p});var r=t(1413),s=t(2791),l=t(9434),n=t(5176),o=t(3158),i=t(2426),c=t.n(i),d=t(4045),u=t(184);const p=()=>{(0,l.I0)();const[e,a]=(0,s.useState)([]),[t,i]=(0,s.useState)([]),[p,m]=(0,s.useState)({nOt:"",bs:"",typeSortie:""}),[h,b]=(0,s.useState)(new Set),[x,y]=(0,s.useState)(!1),[g,v]=(0,s.useState)(null),[j,N]=(0,s.useState)(!1),[_,f]=(0,s.useState)({type_sortie:"OT",nature_sortie:"normal",magasin:"Magasin",articles:[]}),[S,w]=(0,s.useState)([]),k="http://localhost:5000",O=[{header:"N\xb0 OT",key:"n_ot"},{header:"N\xb0 BS",key:"bs"},{header:"N\xb0 LE",key:"le"},{header:"N\xb0 STO",key:"commande_achat"},{header:"Nature de sortie",key:"nature_sortie"},{header:"Type de sortie",key:"type_sortie"},{header:"N\xb0 R\xe9servation",key:"n_reservation"},{header:"Magasin",key:"magasin"},{header:"Local",key:"local"},{header:"Demandeur",key:"demandeur"},{header:"Pr\xe9parateur",key:"preparateur"},{header:"Responsable local",key:"responsable_local"},{header:"Articles",key:"articles"}],E=[{value:"OT",label:"OT"},{value:"BS",label:"BS"},{value:"LE",label:"LE"},{value:"STO",label:"STO"}],C={Magasin:[{value:"MSLE",label:"MSLE/MSLT - BOUZIT LAHSSAN",responsable:"BOUZIT LAHSSAN"},{value:"MSLV",label:"MSLV/MSRL/MSGP/MSLL/MSPC/DSED - BENDADA MOHAMMED",responsable:"BENDADA MOHAMMED"}],"Magasin EPI":[{value:"MSFE",label:"MSFE - BOUALLAK NOURDINE",responsable:"BOUALLAK NOURDINE"}],"Parc Exterieur":[{value:"PEXT",label:"PEXT/el kouhail abdelmajid",responsable:"el kouhail abdelmajid"}]},L={Magasin:"JAMAL RHENNAOUI","Magasin EPI":"ELBAHI AMINE","Parc Exterieur":"SARGALI YOUSSEF"};(0,s.useEffect)((()=>{M(),(async()=>{try{const e=await fetch("".concat(k,"/controle/mb51/articles"));if(console.log("Fetch response:",e.status,e.statusText),!e.ok)throw new Error("HTTP error! Status: ".concat(e.status));const a=await e.json();console.log("Fetched articles:",a),w(a)}catch(e){v("\xc9chec du chargement des articles : ".concat(e.message))}})()}),[p]);const M=async()=>{y(!0),v(null);const e="".concat(k,"/controle/data"),t={nOt:p.nOt||"",bs:p.bs||"",typeSortie:p.typeSortie||""};try{const s=await fetch(e,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)});if(!s.ok)throw new Error("Erreur HTTP ! statut : ".concat(s.status));const l=(await s.json()).map((e=>(0,r.Z)((0,r.Z)({},e),{},{n_ot:e.n_ot?e.n_ot.trim().toLowerCase():"",bs:e.bs?e.bs.trim().toLowerCase():"",le:e.le?e.le.trim().toLowerCase():"",commande_achat:e.commande_achat?e.commande_achat.trim():"",nature_sortie:e.nature_sortie?e.nature_sortie.trim():"",type_sortie:e.type_sortie?e.type_sortie.trim().toLowerCase():"",n_reservation:e.n_reservation?e.n_reservation.trim():"",magasin:e.magasin?e.magasin.trim():"",local:e.local?e.local.trim():"",demandeur:e.demandeur?e.demandeur.trim():"",preparateur:e.preparateur?e.preparateur.trim():"",responsable_local:e.responsable_local?e.responsable_local.trim():"",articles:"string"===typeof e.articles?JSON.parse(e.articles||"[]"):e.articles||[]})));a(l),Z(l)}catch(s){v("\xc9chec du chargement des donn\xe9es : ".concat(s.message))}finally{y(!1)}},Z=e=>{let a=[...e];p.nOt&&(a=a.filter((e=>{var a;return null===(a=e.n_ot)||void 0===a?void 0:a.toLowerCase().includes(p.nOt.toLowerCase())}))),p.bs&&(a=a.filter((e=>{var a;return null===(a=e.bs)||void 0===a?void 0:a.toLowerCase().includes(p.bs.toLowerCase())}))),p.typeSortie&&(a=a.filter((e=>{var a;return(null===(a=e.type_sortie)||void 0===a?void 0:a.toLowerCase())===p.typeSortie.toLowerCase()}))),i(a)},T=async e=>{try{if("add"===e&&_){var a;const e=null===(a=C[_.magasin])||void 0===a?void 0:a.find((e=>e.value===_.local));console.log("New Item before validation:",_);let t=_.n_ot||"",s=_.bs||"",l=_.le||"",n=_.commande_achat||"";if("OT"!==_.type_sortie||t&&""!==t.trim()||(t="OT".concat(c()().format("YYYYMMDDHHmmss")),console.log("Generated n_ot:",t)),"BS"!==_.type_sortie||s&&""!==s.trim()||(s="BS".concat(c()().format("YYYYMMDDHHmmss"))),"LE"!==_.type_sortie||l&&""!==l.trim()||(l="LE".concat(c()().format("YYYYMMDDHHmmss"))),"STO"!==_.type_sortie||n&&""!==n.trim()||(n="STO".concat(c()().format("YYYYMMDDHHmmss"))),"OT"===_.type_sortie&&!t)throw new Error("Le N\xb0 OT est requis pour un type de sortie OT.");if("BS"===_.type_sortie&&!s)throw new Error("Le BS est requis pour un type de sortie BS.");if("LE"===_.type_sortie&&!l)throw new Error("Le LE est requis pour un type de sortie LE.");if("STO"===_.type_sortie&&!n)throw new Error("La commande d'achat est requise pour un type de sortie STO.");const o=(0,r.Z)((0,r.Z)({},_),{},{n_ot:t,bs:s,le:l,commande_achat:n,responsable_local:(null===e||void 0===e?void 0:e.responsable)||_.responsable_local||"",magasin:_.magasin||"Magasin",articles:_.articles.map((e=>({article:e.article,designation_article:e.designation_article,quantity:e.quantity||0})))});console.log("Item to send:",o);const i=await fetch("".concat(k,"/controle/update"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({action:"add",data:o})});if(!i.ok)throw new Error((await i.json()).error||"Erreur lors de l'ajout");N(!1),f({type_sortie:"OT",nature_sortie:"normal",magasin:"Magasin",articles:[]}),await M()}else if("remove"===e&&h.size>0){const e=Array.from(h).map((e=>t[e].n_ot)),a=await fetch("".concat(k,"/controle/update"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({action:"remove",data:e})});if(!a.ok)throw new Error((await a.json()).error||"Erreur lors de la suppression");b(new Set),await M()}}catch(s){v("\xc9chec de la mise \xe0 jour : ".concat(s.message))}};return(0,u.jsx)(n.Z,{title:"Contr\xf4le Livraison",children:(0,u.jsxs)("div",{className:"grid grid-cols-1 gap-4",children:[(0,u.jsxs)("div",{className:"flex space-x-2 mb-4",children:[(0,u.jsx)("input",{type:"text",placeholder:"N\xb0 OT",value:p.nOt,onChange:e=>m((0,r.Z)((0,r.Z)({},p),{},{nOt:e.target.value})),className:"p-2 border rounded"}),(0,u.jsx)("input",{type:"text",placeholder:"BS",value:p.bs,onChange:e=>m((0,r.Z)((0,r.Z)({},p),{},{bs:e.target.value})),className:"p-2 border rounded"}),(0,u.jsxs)("select",{value:p.typeSortie,onChange:e=>m((0,r.Z)((0,r.Z)({},p),{},{typeSortie:e.target.value})),className:"p-2 border rounded",children:[(0,u.jsx)("option",{value:"",children:"Tous les types"}),E.map((e=>(0,u.jsx)("option",{value:e.value,children:e.label},e.value)))]})]}),(g||x)&&(0,u.jsxs)("div",{className:"mb-4",children:[x&&(0,u.jsx)("div",{className:"text-blue-500",children:"Chargement des donn\xe9es..."}),g&&(0,u.jsx)("div",{className:"text-red-500",children:g})]}),(0,u.jsxs)("div",{className:"flex space-x-2 mb-4",children:[(0,u.jsx)("button",{onClick:()=>N(!j),className:"bg-blue-500 text-white p-2 rounded hover:bg-blue-600",disabled:x,children:j?"Annuler":"Ajouter"}),(0,u.jsx)("button",{onClick:()=>T("remove"),className:"bg-red-500 text-white p-2 rounded hover:bg-red-600",disabled:0===h.size||x,children:"Retirer"}),(0,u.jsx)("button",{onClick:()=>{const e=d.P6.json_to_sheet(t),a=d.P6.book_new();d.P6.book_append_sheet(a,e,"Controle Livraisons"),d.NC(a,"controle_livraison_".concat(c()().format("YYYYMMDD_HHmmss"),".xlsx"))},className:"bg-green-500 text-white p-2 rounded hover:bg-green-600",disabled:x,children:"Exporter Excel"}),(0,u.jsx)("button",{onClick:()=>{const e=window.open("","_blank"),a="\n            <html>\n                <head>\n                    <title>Contr\xf4le Livraison - ".concat(c()().format("DD/MM/YYYY HH:mm"),"</title>\n                    <style>\n                        body { font-family: Arial, sans-serif; margin: 20px; color: #000; }\n                        h1 { text-align: center; font-size: 24px; margin-bottom: 10px; }\n                        p { text-align: center; font-size: 14px; color: #555; margin-bottom: 20px; }\n                        table { width: 100%; border-collapse: collapse; font-size: 12px; }\n                        th, td { border: 1px solid #000; padding: 8px; text-align: left; }\n                        th { background-color: #f0f0f0; font-weight: bold; text-transform: uppercase; }\n                        tr:nth-child(even) { background-color: #f9f9f9; }\n                        .no-data { text-align: center; padding: 20px; font-style: italic; }\n                    </style>\n                </head>\n                <body>\n                    <h1>Contr\xf4le Livraison</h1>\n                    <p>Imprim\xe9 le ").concat(c()().format("DD/MM/YYYY HH:mm"),"</p>\n                    <table>\n                        <thead>\n                            <tr>\n                                ").concat(O.map((e=>"<th>".concat(e.header,"</th>"))).join(""),"\n                            </tr>\n                        </thead>\n                        <tbody>\n                            ").concat(0===t.length?'<tr><td colspan="'+O.length+'" class="no-data">Aucune donn\xe9e disponible pour les filtres s\xe9lectionn\xe9s.</td></tr>':t.map((e=>"\n                                        <tr>\n                                            ".concat(O.map((a=>"\n                                                <td>".concat("articles"===a.key&&e[a.key]?Array.isArray(e[a.key])?e[a.key].map((e=>"".concat(e.article," (").concat(e.quantity,")"))).join(", "):e[a.key]:void 0!==e[a.key]&&null!==e[a.key]?e[a.key]:"","</td>\n                                            "))).join(""),"\n                                        </tr>\n                                    "))).join(""),"\n                        </tbody>\n                    </table>\n                </body>\n            </html>\n        ");e.document.write(a),e.document.close(),e.print()},className:"bg-yellow-500 text-white p-2 rounded hover:bg-yellow-600",disabled:x,children:"Imprimer"})]}),j&&(0,u.jsxs)("div",{className:"mb-4 p-4 border rounded bg-gray-50",children:[(0,u.jsx)("h3",{className:"text-lg font-semibold mb-2",children:"Ajouter une nouvelle livraison"}),(0,u.jsxs)("form",{onSubmit:e=>{e.preventDefault(),T("add")},className:"grid grid-cols-2 gap-4",children:[(0,u.jsx)("select",{value:_.type_sortie,onChange:e=>f((0,r.Z)((0,r.Z)({},_),{},{type_sortie:e.target.value,n_ot:"",bs:"",le:"",commande_achat:""})),className:"p-2 border rounded",children:E.map((e=>(0,u.jsx)("option",{value:e.value,children:e.label},e.value)))}),"OT"===_.type_sortie&&(0,u.jsx)("input",{type:"text",placeholder:"N\xb0 OT",value:_.n_ot||"",onChange:e=>f((0,r.Z)((0,r.Z)({},_),{},{n_ot:e.target.value})),className:"p-2 border rounded",required:!0}),"BS"===_.type_sortie&&(0,u.jsx)("input",{type:"text",placeholder:"BS",value:_.bs||"",onChange:e=>f((0,r.Z)((0,r.Z)({},_),{},{bs:e.target.value})),className:"p-2 border rounded",required:!0}),"LE"===_.type_sortie&&(0,u.jsx)("input",{type:"text",placeholder:"LE",value:_.le||"",onChange:e=>f((0,r.Z)((0,r.Z)({},_),{},{le:e.target.value})),className:"p-2 border rounded",required:!0}),"STO"===_.type_sortie&&(0,u.jsx)("input",{type:"text",placeholder:"STO",value:_.commande_achat||"",onChange:e=>f((0,r.Z)((0,r.Z)({},_),{},{commande_achat:e.target.value})),className:"p-2 border rounded",required:!0}),(0,u.jsx)("select",{value:_.nature_sortie,onChange:e=>f((0,r.Z)((0,r.Z)({},_),{},{nature_sortie:e.target.value})),className:"p-2 border rounded",children:[{value:"urgent",label:"Urgent"},{value:"normal",label:"Normal"},{value:"session",label:"Session"}].map((e=>(0,u.jsx)("option",{value:e.value,children:e.label},e.value)))}),(0,u.jsx)("input",{type:"text",placeholder:"N\xb0 R\xe9servation",value:_.n_reservation||"",onChange:e=>f((0,r.Z)((0,r.Z)({},_),{},{n_reservation:e.target.value})),className:"p-2 border rounded"}),(0,u.jsx)("select",{value:_.magasin,onChange:e=>f((0,r.Z)((0,r.Z)({},_),{},{magasin:e.target.value,local:"",responsable_local:""})),className:"p-2 border rounded",children:[{value:"Magasin",label:"Magasin"},{value:"Magasin EPI",label:"Magasin EPI"},{value:"Parc Exterieur",label:"Parc Exterieur"}].map((e=>(0,u.jsxs)("option",{value:e.value,children:[e.label," - ",L[e.value]]},e.value)))}),(0,u.jsxs)("select",{value:_.local,onChange:e=>{const a=C[_.magasin].find((a=>a.value===e.target.value));f((0,r.Z)((0,r.Z)({},_),{},{local:e.target.value,responsable_local:(null===a||void 0===a?void 0:a.responsable)||""}))},className:"p-2 border rounded",children:[(0,u.jsx)("option",{value:"",children:"S\xe9lectionner un local"}),_.magasin&&C[_.magasin].map((e=>(0,u.jsx)("option",{value:e.value,children:e.label},e.value)))]}),(0,u.jsx)("input",{type:"text",placeholder:"Demandeur",value:_.demandeur||"",onChange:e=>f((0,r.Z)((0,r.Z)({},_),{},{demandeur:e.target.value})),className:"p-2 border rounded"}),(0,u.jsx)("input",{type:"text",placeholder:"Pr\xe9parateur",value:_.preparateur||"",onChange:e=>f((0,r.Z)((0,r.Z)({},_),{},{preparateur:e.target.value})),className:"p-2 border rounded"}),(0,u.jsx)("input",{type:"text",placeholder:"Responsable local",value:_.responsable_local||"",readOnly:!0,className:"p-2 border rounded bg-gray-100"}),(0,u.jsxs)("div",{className:"col-span-2",children:[(0,u.jsx)("h4",{className:"text-md font-semibold mb-2",children:"Ajouter des articles"}),(0,u.jsxs)("select",{onChange:e=>{const[a,t]=e.target.value.split(" - ");a&&t&&!_.articles.some((e=>e.article===a))&&((e,a)=>{_.articles.some((a=>a.article===e))||f((t=>(0,r.Z)((0,r.Z)({},t),{},{articles:[...t.articles,{article:e,designation_article:a,quantity:0}]})))})(a,t),e.target.value=""},className:"p-2 border rounded w-full mb-2",children:[(0,u.jsx)("option",{value:"",children:"S\xe9lectionner un article"}),S&&S.length>0?[...new Set(S.map((e=>e.article)))].map((e=>{var a;const t=null===(a=S.find((a=>a.article===e)))||void 0===a?void 0:a.designation_article;return(0,u.jsxs)("option",{value:"".concat(e," - ").concat(t),children:[e," - ",t]},e)})):(0,u.jsx)("option",{disabled:!0,children:"Aucun article disponible"})]}),_.articles.length>0&&(0,u.jsx)("div",{className:"mt-2 overflow-x-auto",children:(0,u.jsxs)("table",{className:"w-full text-sm border-collapse",children:[(0,u.jsx)("thead",{children:(0,u.jsxs)("tr",{className:"bg-gray-100",children:[(0,u.jsx)("th",{className:"border p-2 text-left",children:"Code"}),(0,u.jsx)("th",{className:"border p-2 text-left",children:"D\xe9signation"}),(0,u.jsx)("th",{className:"border p-2 text-left",children:"Quantit\xe9"}),(0,u.jsx)("th",{className:"border p-2 text-left",children:"Actions"})]})}),(0,u.jsx)("tbody",{children:_.articles.map(((e,a)=>(0,u.jsxs)("tr",{className:"hover:bg-gray-50",children:[(0,u.jsx)("td",{className:"border p-2",children:e.article}),(0,u.jsx)("td",{className:"border p-2",children:e.designation_article}),(0,u.jsx)("td",{className:"border p-2",children:(0,u.jsx)("input",{type:"number",min:"0",value:e.quantity,onChange:e=>((e,a)=>{const t=[..._.articles];t[e].quantity=a||0,f((e=>(0,r.Z)((0,r.Z)({},e),{},{articles:t})))})(a,e.target.value),className:"p-1 border rounded w-20",placeholder:"Quantit\xe9"})}),(0,u.jsx)("td",{className:"border p-2",children:(0,u.jsx)("button",{type:"button",onClick:()=>(e=>{const a=[..._.articles];a.splice(e,1),f((e=>(0,r.Z)((0,r.Z)({},e),{},{articles:a})))})(a),className:"text-red-500 hover:text-red-700",children:(0,u.jsx)(o.Z,{className:"h-5 w-5"})})})]},e.article)))})]})}),0===_.articles.length&&(0,u.jsx)("p",{className:"text-gray-500 italic",children:"Aucun article s\xe9lectionn\xe9."})]}),(0,u.jsx)("button",{type:"submit",className:"col-span-2 bg-blue-500 text-white p-2 rounded hover:bg-blue-600",disabled:x,children:"Ajouter la livraison"})]})]}),(0,u.jsx)("div",{className:"overflow-x-auto",children:(0,u.jsxs)("table",{id:"controle-table",className:"w-full text-sm text-left text-gray-500",children:[(0,u.jsx)("thead",{className:"text-xs text-gray-700 uppercase bg-gray-50",children:(0,u.jsxs)("tr",{children:[(0,u.jsx)("th",{className:"px-4 py-2",children:(0,u.jsx)("input",{type:"checkbox",onChange:e=>b(e.target.checked?new Set(t.map(((e,a)=>a))):new Set),disabled:x})}),O.map((e=>(0,u.jsx)("th",{className:"px-4 py-2",children:e.header},e.key))),(0,u.jsx)("th",{className:"px-4 py-2",children:"Actions"})]})}),(0,u.jsx)("tbody",{children:0===t.length?(0,u.jsx)("tr",{children:(0,u.jsx)("td",{colSpan:O.length+2,className:"px-4 py-2 text-center text-gray-500",children:"Aucune donn\xe9e disponible pour les filtres s\xe9lectionn\xe9s."})}):t.map(((e,a)=>(0,u.jsxs)("tr",{className:"".concat(h.has(a)?"bg-gray-100":""," border-b hover:bg-gray-50"),children:[(0,u.jsx)("td",{className:"px-4 py-2",children:(0,u.jsx)("input",{type:"checkbox",checked:h.has(a),onChange:()=>(e=>{const a=new Set(h);a.has(e)?a.delete(e):a.add(e),b(a)})(a),disabled:x})}),O.map((a=>(0,u.jsx)("td",{className:"px-4 py-2",children:"articles"===a.key&&e[a.key]?Array.isArray(e[a.key])?e[a.key].map((e=>"".concat(e.article," (").concat(e.quantity,")"))).join(", "):JSON.parse(e[a.key]).map((e=>"".concat(e.article," (").concat(e.quantity,")"))).join(", "):void 0!==e[a.key]&&null!==e[a.key]?e[a.key]:""},a.key))),(0,u.jsx)("td",{className:"px-4 py-2",children:(0,u.jsx)("button",{onClick:()=>(async e=>{try{const a=t[e].n_ot,r=await fetch("".concat(k,"/controle/update"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({action:"remove",data:[a]})});if(!r.ok)throw new Error((await r.json()).error||"Erreur lors de la suppression");b(new Set),await M()}catch(a){v("\xc9chec de la suppression : ".concat(a.message))}})(a),className:"text-red-500 hover:text-red-700",disabled:x,children:(0,u.jsx)(o.Z,{className:"h-5 w-5"})})})]},a)))})]})})]})})}}}]);
//# sourceMappingURL=553.f9eeda9d.chunk.js.map